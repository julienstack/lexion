<p-toast />
<p-confirmDialog />

<div class="flex flex-col lg:flex-row gap-4 h-full">
    <!-- Left Panel: Categories & Article List -->
    <div class="lg:w-72 xl:w-80 flex-shrink-0 flex flex-col">
        <!-- Header & New Button -->
        <div class="flex items-center justify-between mb-3">
            <div>
                <h1 class="text-xl font-bold text-white">Wiki</h1>
                <p class="text-xs text-gray-500 hidden md:block">Wissensdatenbank</p>
            </div>
            @if (auth.isAdmin()) {
            <p-button icon="pi pi-plus" severity="danger" [rounded]="true" size="small" pTooltip="Neuer Artikel"
                (click)="openNew()"></p-button>
            }
        </div>

        <!-- Search -->
        <div class="relative mb-3">
            <i class="pi pi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
            <input pInputText type="text" (input)="onSearch($event)" placeholder="Suchen..."
                class="w-full pl-8 py-1.5 text-sm !bg-gray-800 !border-gray-700 rounded-lg" />
        </div>

        <!-- Categories (Accordion Style) -->
        <div class="bg-gray-900/50 border border-gray-800 rounded-xl overflow-hidden flex-1 flex flex-col min-h-0">
            <!-- All Articles -->
            <button (click)="filterCategory(null)"
                [class]="selectedCategory() === null ? 'bg-pink-600/20 border-l-2 border-l-pink-500' : 'border-l-2 border-l-transparent hover:bg-gray-800/50'"
                class="w-full text-left p-2.5 flex items-center justify-between text-sm transition-colors">
                <span class="flex items-center gap-2">
                    <i class="pi pi-folder text-gray-400 text-xs"></i>
                    <span [class]="selectedCategory() === null ? 'text-white font-medium' : 'text-gray-400'">Alle
                        Artikel</span>
                </span>
                <span class="text-[10px] bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded-full">{{docs().length}}</span>
            </button>

            <!-- Category Sections -->
            @for (cat of ['General', 'Finance', 'Tech', 'Legal']; track cat) {
            <div class="border-t border-gray-800">
                <button (click)="toggleCategory(cat)"
                    [class]="selectedCategory() === cat ? 'bg-pink-600/20 border-l-2 border-l-pink-500' : 'border-l-2 border-l-transparent hover:bg-gray-800/50'"
                    class="w-full text-left p-2.5 flex items-center justify-between text-sm transition-colors">
                    <span class="flex items-center gap-2">
                        <i class="pi text-xs" [ngClass]="{
                            'pi-info-circle text-blue-400': cat === 'General',
                            'pi-dollar text-green-400': cat === 'Finance',
                            'pi-cog text-purple-400': cat === 'Tech',
                            'pi-shield text-red-400': cat === 'Legal'
                        }"></i>
                        <span [class]="selectedCategory() === cat ? 'text-white font-medium' : 'text-gray-400'">
                            {{getCategoryLabel(cat)}}
                        </span>
                    </span>
                    <div class="flex items-center gap-1.5">
                        <span
                            class="text-[10px] bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded-full">{{getCountByCategory(cat)}}</span>
                        <i class="pi text-[10px] text-gray-500"
                            [class]="expandedCategories[cat] ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                    </div>
                </button>

                <!-- Articles in Category -->
                @if (expandedCategories[cat]) {
                <div class="bg-gray-800/30">
                    @for (doc of getDocsByCategory(cat); track doc.id) {
                    <button (click)="selectArticle(doc)"
                        [class]="selectedArticle()?.id === doc.id ? 'bg-gray-700/50 text-white' : 'text-gray-400 hover:bg-gray-800/50 hover:text-gray-200'"
                        class="w-full text-left px-4 py-2 text-xs border-l-2 border-l-transparent transition-colors truncate flex items-center gap-2">
                        <i class="pi pi-file text-[10px]"></i>
                        <span class="truncate">{{doc.title}}</span>
                    </button>
                    } @empty {
                    <div class="px-4 py-2 text-xs text-gray-500 italic">Keine Artikel</div>
                    }
                </div>
                }
            </div>
            }
        </div>
    </div>

    <!-- Right Panel: Article Content -->
    <div class="flex-1 min-w-0 flex flex-col">
        @if (loading()) {
        <div class="flex-1 flex items-center justify-center">
            <p-progressSpinner strokeWidth="4" ariaLabel="Lade..." />
        </div>
        } @else if (selectedArticle()) {
        <!-- Article View -->
        <div class="bg-gray-900/50 border border-gray-800 rounded-xl flex-1 flex flex-col overflow-hidden">
            <!-- Article Header -->
            <div class="p-4 border-b border-gray-800 flex items-start justify-between gap-3">
                <div class="min-w-0">
                    <h2 class="text-lg font-bold text-white truncate">{{selectedArticle()!.title}}</h2>
                    <p class="text-sm text-gray-400 mt-0.5 line-clamp-2">{{selectedArticle()!.description}}</p>
                    <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
                        <span class="flex items-center gap-1">
                            <i class="pi pi-user text-[10px]"></i>
                            {{selectedArticle()!.author}}
                        </span>
                        <p-tag [value]="getCategoryLabel(selectedArticle()!.category)"
                            [severity]="getCategorySeverity(selectedArticle()!.category)"
                            styleClass="!text-[10px] !px-1.5 !py-0.5"></p-tag>
                        <span class="flex items-center gap-1">
                            <i class="pi text-[10px]" [ngClass]="{
                                'pi-check-circle text-green-500': selectedArticle()!.status === 'Published',
                                'pi-file text-yellow-500': selectedArticle()!.status === 'Draft',
                                'pi-eye text-blue-500': selectedArticle()!.status === 'Review'
                            }"></i>
                            {{getStatusLabel(selectedArticle()!.status)}}
                        </span>
                    </div>
                </div>
                @if (auth.isAdmin()) {
                <div class="flex items-center gap-1 flex-shrink-0">
                    <p-button icon="pi pi-pencil" [text]="true" [rounded]="true" severity="info" size="small"
                        pTooltip="Bearbeiten" (click)="editDoc(selectedArticle()!)"></p-button>
                    <p-button icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger" size="small"
                        pTooltip="Löschen" (click)="confirmDelete(selectedArticle()!)"></p-button>
                </div>
                }
            </div>

            <!-- Article Content -->
            <div class="flex-1 overflow-y-auto p-4">
                @if (selectedArticle()!.content) {
                <div class="prose prose-invert prose-sm max-w-none">
                    <div class="text-gray-300 whitespace-pre-wrap leading-relaxed">{{selectedArticle()!.content}}</div>
                </div>
                } @else {
                <div class="text-gray-500 italic text-sm">Kein Inhalt verfügbar.</div>
                }
            </div>
        </div>
        } @else {
        <!-- Empty State - No Article Selected -->
        <div class="flex-1 flex items-center justify-center bg-gray-900/30 border border-gray-800 rounded-xl">
            <div class="text-center">
                <i class="pi pi-book text-4xl text-gray-600 mb-3"></i>
                <p class="text-gray-500 text-sm">Wähle einen Artikel aus der Liste</p>
                @if (auth.isAdmin()) {
                <p-button label="Neuen Artikel erstellen" icon="pi pi-plus" [text]="true" size="small" styleClass="mt-3"
                    (click)="openNew()"></p-button>
                }
            </div>
        </div>
        }
    </div>
</div>

<!-- Wiki Dialog -->
<p-dialog [header]="editMode() ? 'Artikel bearbeiten' : 'Neuer Artikel'" [(visible)]="dialogVisible" [modal]="true"
    [draggable]="false" [resizable]="false" maskStyleClass="backdrop-blur-sm bg-black/50"
    [style]="{width: '700px', maxWidth: '95vw'}" [closable]="!saving()">
    <div class="space-y-3">
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Titel *</label>
            <input pInputText [(ngModel)]="currentDoc.title" class="w-full" placeholder="Artikeltitel" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Beschreibung *</label>
            <input pInputText [(ngModel)]="currentDoc.description" class="w-full" placeholder="Kurzbeschreibung" />
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Kategorie</label>
                <p-select [(ngModel)]="currentDoc.category" [options]="categoryOptions" optionLabel="label"
                    optionValue="value" styleClass="w-full" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                <p-select [(ngModel)]="currentDoc.status" [options]="statusOptions" optionLabel="label"
                    optionValue="value" styleClass="w-full" />
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Sichtbarkeit</label>
            <p-select [(ngModel)]="tempVisibility" [options]="visibilityOptions" optionLabel="label" optionValue="value"
                styleClass="w-full" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Autor</label>
            <input pInputText [(ngModel)]="currentDoc.author" class="w-full" placeholder="Dein Name" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Inhalt</label>
            <textarea pTextarea [(ngModel)]="currentDoc.content" class="w-full" rows="8"
                placeholder="Inhalt..."></textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Abbrechen" severity="secondary" [text]="true" (click)="dialogVisible.set(false)"
            [disabled]="saving()" />
        <p-button [label]="editMode() ? 'Speichern' : 'Erstellen'" icon="pi pi-check" (click)="saveDoc()"
            [loading]="saving()" />
    </ng-template>
</p-dialog>