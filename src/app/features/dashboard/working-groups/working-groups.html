<p-toast />
<p-confirmDialog />

<div class="p-2 md:p-6">
    <!-- Loading -->
    @if (loading()) {
    <div class="flex justify-center items-center py-8">
        <p-progressSpinner strokeWidth="4" ariaLabel="Lade AGs..." />
    </div>
    }

    <!-- Error -->
    @if (error()) {
    <p-message severity="error" [text]="'Fehler: ' + error()" styleClass="mb-3 w-full" />
    }

    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-xl md:text-3xl font-bold text-white">Arbeitsgemeinschaften (AGs)</h1>
            <p class="text-gray-400 text-sm hidden md:block mt-1">Hier findest du alle aktiven Gruppen</p>
        </div>
        @if (auth.isAdmin()) {
        <p-button label="Neu" icon="pi pi-plus" severity="danger" [raised]="true" size="small"
            (click)="openNew()"></p-button>
        }
    </div>

    <!-- AG List -->
    <div class="space-y-2">
        @for (group of groups(); track group.id) {
        <div class="bg-gray-800/40 border border-gray-700/50 rounded-lg overflow-hidden">
            <!-- Header (Always Visible) -->
            <div class="p-3 cursor-pointer" (click)="toggleExpand(group.id!)">
                <div class="flex items-center gap-3">
                    <!-- Avatar -->
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-sm font-bold flex-shrink-0"
                        [style.background-color]="getAvatarColor(group.name)">
                        {{getInitials(group.name)}}
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <h3 class="text-sm md:text-base font-bold text-white truncate">{{group.name}}</h3>
                        <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-400 mt-0.5">
                            <span class="flex items-center gap-1">
                                <i [ngClass]="getIconForType(group.contact_type)" class="text-[10px]"></i>
                                {{group.contact_type}}
                            </span>
                            <span class="flex items-center gap-1">
                                <i class="pi pi-users text-[10px]"></i>
                                {{group.members_count}} Mitgl.
                            </span>
                            @if (getAgEvents(group.id!).length > 0) {
                            <span class="hidden sm:flex items-center gap-1">
                                <i class="pi pi-calendar text-[10px]"></i>
                                {{getAgEvents(group.id!)[0].date}}
                            </span>
                            } @else {
                            <span class="hidden sm:flex items-center gap-1 text-gray-500">
                                <i class="pi pi-calendar text-[10px]"></i>
                                Kein Termin
                            </span>
                            }
                        </div>
                    </div>

                    <!-- Actions + Expand -->
                    <div class="flex items-center gap-1 flex-shrink-0">
                        @if (auth.isAdmin()) {
                        <button (click)="editGroup(group); $event.stopPropagation()"
                            class="w-7 h-7 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 transition-colors">
                            <i class="pi pi-pencil text-xs"></i>
                        </button>
                        <button (click)="confirmDelete(group); $event.stopPropagation()"
                            class="w-7 h-7 rounded-full flex items-center justify-center text-gray-400 hover:text-red-400 hover:bg-gray-700 transition-colors">
                            <i class="pi pi-trash text-xs"></i>
                        </button>
                        }
                        <i class="pi text-gray-400 text-xs ml-1"
                            [class]="expandedGroups[group.id!] ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                    </div>
                </div>
            </div>

            <!-- Expanded Content -->
            @if (expandedGroups[group.id!]) {
            <div class="border-t border-gray-700/50 p-3 bg-gray-800/20 space-y-3">
                <!-- Description -->
                <div>
                    <div class="text-[10px] uppercase text-gray-500 font-semibold mb-1">Beschreibung</div>
                    <p class="text-sm text-gray-300">{{group.description || 'Keine Beschreibung'}}</p>
                </div>

                <!-- Tags -->
                @if (group.tags && group.tags.length > 0) {
                <div>
                    <div class="text-[10px] uppercase text-gray-500 font-semibold mb-1">Schwerpunkte</div>
                    <div class="flex flex-wrap gap-1">
                        @for (tag of group.tags; track tag) {
                        <span class="px-2 py-0.5 bg-gray-700 text-gray-300 rounded-full text-[10px]">{{tag}}</span>
                        }
                    </div>
                </div>
                }

                <!-- Lead & Next Meeting -->
                <div class="flex flex-wrap gap-4 text-sm">
                    <div>
                        <div class="text-[10px] uppercase text-gray-500 font-semibold">Leitung</div>
                        <div class="text-white">{{group.lead || '-'}}</div>
                    </div>
                    @if (group.next_meeting) {
                    <div>
                        <div class="text-[10px] uppercase text-gray-500 font-semibold">Nächstes Treffen</div>
                        <div class="text-white">{{group.next_meeting}}</div>
                    </div>
                    }
                </div>

                <!-- Upcoming Events -->
                @if (getAgEvents(group.id!).length > 0) {
                <div>
                    <div class="text-[10px] uppercase text-gray-500 font-semibold mb-1">Termine</div>
                    <div class="space-y-1">
                        @for (evt of getAgEvents(group.id!).slice(0, 2); track evt.id) {
                        <div class="flex items-center gap-2 text-xs bg-gray-900/50 rounded px-2 py-1.5">
                            <i class="pi pi-calendar text-pink-400 text-[10px]"></i>
                            <span class="text-white">{{evt.title}}</span>
                            <span class="text-gray-500">{{evt.date}} • {{evt.start_time}}</span>
                        </div>
                        }
                    </div>
                </div>
                }

                <!-- Join Actions -->
                <div class="pt-2 border-t border-gray-700/50">
                    @if (auth.isLoggedIn()) {
                    <div class="flex flex-wrap gap-2">
                        @if (group.contact_link) {
                        <a [href]="group.contact_link" target="_blank" class="flex-1 min-w-[120px]">
                            <p-button [label]="group.contact_type" [icon]="getIconForType(group.contact_type)"
                                styleClass="w-full" severity="danger" size="small"></p-button>
                        </a>
                        }
                        <p-button [label]="myMemberships().has(group.id!) ? 'Verlassen' : 'Beitreten'"
                            [icon]="myMemberships().has(group.id!) ? 'pi pi-sign-out' : 'pi pi-user-plus'"
                            [severity]="myMemberships().has(group.id!) ? 'secondary' : 'contrast'"
                            [outlined]="myMemberships().has(group.id!)" size="small"
                            (click)="toggleMembership(group); $event.stopPropagation()">
                        </p-button>
                    </div>
                    } @else {
                    <a routerLink="/login">
                        <p-button label="Anmelden zum Beitreten" icon="pi pi-sign-in" size="small" severity="secondary"
                            styleClass="w-full"></p-button>
                    </a>
                    }
                </div>
            </div>
            }
        </div>
        } @empty {
        <div class="text-center py-8 text-gray-500">
            <i class="pi pi-users text-3xl mb-2"></i>
            <p class="text-sm">Keine AGs gefunden</p>
        </div>
        }
    </div>
</div>

<!-- AG Dialog -->
<p-dialog [header]="editMode() ? 'AG bearbeiten' : 'Neue AG'" [(visible)]="dialogVisible" [modal]="true"
    [draggable]="false" [resizable]="false" maskStyleClass="backdrop-blur-sm bg-black/50"
    [style]="{width: '600px', maxWidth: '95vw'}" [closable]="!saving()">
    <div class="space-y-3">
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Name *</label>
            <input pInputText [(ngModel)]="currentGroup.name" class="w-full" placeholder="z.B. Öffentlichkeitsarbeit" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Beschreibung *</label>
            <textarea pTextarea [(ngModel)]="currentGroup.description" class="w-full" rows="2"
                placeholder="Zielsetzung..."></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Leitung *</label>
                <input pInputText [(ngModel)]="currentGroup.lead" class="w-full" placeholder="Name" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Nächstes Treffen</label>
                <input pInputText [(ngModel)]="currentGroup.next_meeting" class="w-full" placeholder="Montags 19:00" />
            </div>
        </div>

        <div class="border-t border-gray-700 pt-3">
            <h4 class="text-white font-medium mb-2 text-sm">Kontakt</h4>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Typ</label>
                    <p-select [(ngModel)]="currentGroup.contact_type" [options]="contactTypes" optionLabel="label"
                        optionValue="value" styleClass="w-full">
                        <ng-template pTemplate="selectedItem" let-item>
                            <div class="flex items-center gap-2" *ngIf="item">
                                <i [class]="item.icon"></i>
                                <span>{{item.label}}</span>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-item>
                            <div class="flex items-center gap-2">
                                <i [class]="item.icon"></i>
                                <span>{{item.label}}</span>
                            </div>
                        </ng-template>
                    </p-select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Anzeige-Wert</label>
                    <input pInputText [(ngModel)]="currentGroup.contact_value" class="w-full" placeholder="#kanal" />
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Link</label>
                    <input pInputText [(ngModel)]="currentGroup.contact_link" class="w-full"
                        placeholder="https://discord.gg/..." />
                </div>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Tags (Komma-getrennt)</label>
            <input pInputText [(ngModel)]="tagsInput" class="w-full" placeholder="technik, design..." />
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Abbrechen" severity="secondary" [text]="true" (click)="dialogVisible.set(false)"
            [disabled]="saving()" />
        <p-button [label]="editMode() ? 'Speichern' : 'Erstellen'" icon="pi pi-check" (click)="saveGroup()"
            [loading]="saving()" />
    </ng-template>
</p-dialog>